<html>

	<head>
	    <title>My Groups</title>

	    <!-- include stylesheets and bootstrap -->
	    <meta charset="utf-8">
	    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	     <!-- Optional theme -->
	    <link  href="https:///bootswatch.com/paper/bootstrap.min.css" Rel="stylesheet" id="bs-theme-stylesheet">

	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	   	<link rel="stylesheet" type="text/css" href="style.css">

	  	<!-- firebase -->
	   	<script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>

	</head>

<script>
	function choresLink() {
    window.location.href = "chorespage.html";
	}

	function gotoHomepage()
 	{
    //assigns correct url to home button
      var home = "homepage.html?";
      var UrlString = window.location.toString();
      var userIndex = UrlString.indexOf("?") + 1;  
      var leftUrlSubString = UrlString.substring(userIndex, UrlString.length);
      home = home.concat(leftUrlSubString);
      window.location.href=home;

  	}
</script>

<script>
  function logout(){
  	var ref = new Firebase("https://flickering-inferno-1570.firebaseio.com/");
	ref.unauth();
  }
</script>
<!-- For login sensitive pages! -->
<!-- Be sure to encompass the body with a div id="body" -->
<script>
	function gotoLogin() {
		window.location.href="login.html?";
	}
	function gotoRegister() {
		window.location.href="register.html?";
	}
	function loginCheck(){
		var ref = new Firebase("https://flickering-inferno-1570.firebaseio.com/");
		var authData = ref.getAuth();

		if (authData) {
			// Insert any function you want here
		}
		else
		{
			document.getElementById('main').innerHTML = "<h3><center>You are not logged in</center></h3>" + 
			"<center><button class='btn-default btn' onclick='gotoLogin()'>Login</button></center>" +
			"<br><center><button class='btn-default btn' onclick='gotoRegister()'>Register</button></center>"; 
		}		
	}
</script>

<script>

  //this function auto initalizes the data onto the page, when page is loaded
  $(document).ready(function () {
  var UrlString = window.location.toString();
  var userIndex = UrlString.indexOf("?") + 1;   
  var UrlSubString = UrlString.substring(userIndex, UrlString.length); 
  
  usersUrl = 'https://flickering-inferno-1570.firebaseio.com/Users/';
  usersUrl = usersUrl.concat(UrlSubString);
  usersUrl = usersUrl.concat('/Groups');
  var usersRef = new Firebase(usersUrl);
  usersRef.once("value", function(snapshot) {
      var hasGroup = snapshot.hasChild("Dummy");
      if(hasGroup == false) {
        snapshot.forEach(function(valueSnapshot) {
			var groupKey = valueSnapshot.child("value").val();
			
			groupsUrl = 'https://flickering-inferno-1570.firebaseio.com/Groups/';
			groupsUrl = groupsUrl.concat(groupKey);
			var groupsRef = new Firebase(groupsUrl);
			groupsRef.once("value", function(nameSnapshot) {
				var groupName = nameSnapshot.child("GroupName").val();
				var btn = document.createElement("BUTTON");


				// adds attributes to the button
				btn.setAttribute("id", groupName);
				btn.setAttribute("class", "btn btn-primary");
				
				// adds the button onscreen
				var t = document.createTextNode(groupName);
				btn.appendChild(t);
				// myItem.appendChild(btn);
				// document.getElementById("myItem").appendChild(btn);
				document.getElementById("scrollingButtonsGroups").appendChild(btn);

				// adds script to button
				document.getElementById(groupName).onclick = function() {  
				  var choreUrl = 'chorespage.html?';
				  var finalChoreUrl = choreUrl.concat(UrlSubString);
				  var finalChoreUrl2 = finalChoreUrl.concat("&");
				  var finalChoreUrl3 = finalChoreUrl2.concat(groupKey);
				  window.location.href=finalChoreUrl3;
				};
			});
		});
      }
    });
  });

  function addGroup() {
	  
    // declares the button
   	var groupName = prompt("Please enter your group name", "Group X");
    var btn = document.createElement("BUTTON");

    // adds attributes to the button
    btn.setAttribute("id", groupName);
    
    // adds the button onscreen
    var t = document.createTextNode(groupName);
    btn.appendChild(t);
    document.getElementById("scrollingButtonsGroups").appendChild(btn);

    var groupUrl = 'https://flickering-inferno-1570.firebaseio.com/Groups';
    //groupUrl.concat(person);
    //groupUrl.concat("/");
    var UrlString = window.location.toString();
    var userIndex = UrlString.indexOf("?") + 1;   
    var UrlSubString = UrlString.substring(userIndex, UrlString.length);

    var groupDataRef = new Firebase(groupUrl);
    var newGroupRef = groupDataRef.push();
    newGroupRef.set({GroupName: groupName ,Members: {Dummy: 0}, Chores: {Dummy: 0}});


    var keyIndex = newGroupRef.toString().lastIndexOf("/") + 1;
    var keyString = newGroupRef.toString().substring(keyIndex, newGroupRef.length);

    var newGroupRef2 = newGroupRef.toString();
    newGroupRef2 = newGroupRef2.concat("/Members");
    var insertMemberRef = new Firebase(newGroupRef2);
    var anotherVarRef = insertMemberRef.push();
    anotherVarRef.set({value: UrlSubString});
    
    //Remove dummy
    var removeDummyUrl = 'https://flickering-inferno-1570.firebaseio.com/Groups/';
    removeDummyUrl = removeDummyUrl.concat(keyString);
    removeDummyUrl = removeDummyUrl.concat('/Members/Dummy');
    var removeDummy = new Firebase(removeDummyUrl);
    alert(removeDummy);
    removeDummy.remove();
    
    var userUrl = 'https://flickering-inferno-1570.firebaseio.com/Users/';
    userUrl = userUrl.concat(UrlSubString);
    userUrl = userUrl.concat("/Groups");
    //alert(userUrl);


    var userDataRef = new Firebase(userUrl);

    var newUserGroup = userDataRef.push();
        newUserGroup.update({value: keyString});
    userDataRef.once("value", function(snapshot) {
      var hasGroup = snapshot.hasChild("Dummy");
      if(hasGroup == true) {
        removeDummyUrl = 'https://flickering-inferno-1570.firebaseio.com/Users/';
        removeDummyUrl = removeDummyUrl.concat(UrlSubString);
        removeDummyUrl = removeDummyUrl.concat("/Groups/Dummy");
        removeDummy = new Firebase(removeDummyUrl);
        removeDummy.remove();
      }
    });

    // adds script to button, appends user string to the end and the groupname appended also
    document.getElementById(groupName).onclick = function() {
      var UrlString = window.location.toString();
      var userIndex = UrlString.indexOf("?") + 1;   
      var UrlSubString = UrlString.substring(userIndex, UrlString.length);   
      var choreUrl = 'chorespage.html?';
      var finalChoreUrl = choreUrl.concat(UrlSubString);
      var finalChoreUrl2 = finalChoreUrl.concat("&");
      var finalChoreUrl3 = finalChoreUrl2.concat(newGroupRef.toString());
      window.location.href=finalChoreUrl3;
    };
  }
</script>

<!-- <body onload="loginCheck()"> -->
<body>
		<!-- title bar header -->
		<hr class="topline">
		
<!-- wrapper around entire body -->
	<div id="wrapper">
		
		<!-- title bar header -->
		<div id="header">
			<div id="headerInner">
				<!-- makes a horizontal list hlding title and icons -->

				<ul class="nav nav-pills">

				<!-- Chorganize Title -->
				<li><img class="title" src="photos/ChOrganizelogo.png" onclick="gotoHomepage()"></li>


				<!-- Setting menu -->
			  	<li role="presentation" class="dropdown">
			    	<a class="dropdown-toggle" data-toggle="dropdown"
			    	role="button" aria-haspopup="true" aria-expanded="false">
			    	<img class="titlePic" src="photos/orangeGear.png"> <span class="caret"></span>
			    	</a>

				    <ul class="dropdown-menu">
				    	<li style="padding:15px;"><a>Page Layout</a></li>
				    	<li style="padding:15px;"><a>History</a></li>
				    	<li role="separator" class="divider"></li>
				    	<li style="padding:15px;"><a>General</a></li>
				    </ul>
			  	</li>

			  	<!-- User Profile Menu -->
			  	<li role="presentation" class="dropdown">
			    	<a class="dropdown-toggle" data-toggle="dropdown"
			    	role="button" aria-haspopup="true" aria-expanded="false">
			    	<img class="titlePic" src="photos/profilePic.png"> <span class="caret"></span>
			    	</a>

				    <ul class="dropdown-menu">
				    	<li style="padding:15px;"><a href="profilePage.html">Profile</a></li>
				    	<li style="padding:15px;"><a>Friends</a></li>
				    	<li style="padding:15px;"><a>Edit</a></li>
				    	<li role="separator" class="divider"></li>
				    	<li style="padding:15px;"><a href="login.html" onclick="logout()">Logout</a></li>
				    </ul>
			  	</li>

			  </ul>

				
			</div>
		</div>

		<hr class="bottomline">


		<div id="body">

			<h3 style="text-align:center;">My Group List</h3>
			<!-- main buttons -->
			<div id="main">
				<ul>
					<!-- put a picture and a button in each 'list' item (row) -->
					<li><img class = "buttonPic" src="photos/backArrow.png"><button class="btn-default btn" onclick="gotoHomepage()">Go Back</button></li>
					<li><img class = "buttonPic" src="photos/addNewGroup.png"><button class="btn-default btn" onclick="addGroup()">Add a new group</button></li>
				</ul>

				<h4 style="text-align:center;"> My Groups </h4>

				<!-- this wrapper will hold all the buttons leading to the user's groups -->
				<div id="scrollingButtonsGroups" class="btn-group-vertical" style="float:center">
				</div>

			</div>
		</div>



	</div>

</body>

</html>
